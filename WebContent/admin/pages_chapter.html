<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>章节管理</title>
<link rel="icon" href="favicon.ico" type="image/ico">


<meta name="author" content="yinqi">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/materialdesignicons.min.css" rel="stylesheet">
<link href="css/style.css" rel="stylesheet">
<link href="css/mypages.css" rel="stylesheet">

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/perfect-scrollbar.min.js"></script>
<script type="text/javascript" src="js/main.js"></script>
<script type="text/javascript" src="js/qiniu.min.js"></script>
<script type="text/javascript" src="dialog/dialog_js/MiniDialog-es5.min.js"></script>
<script type="text/javascript" src="js/my_js/chapter.js"></script>
</head>

<body data-logobg="color_8" data-sidebarbg="color_8">
<div class="lyear-layout-web">
  <div class="lyear-layout-container">
    <!--左侧导航-->
    <aside class="lyear-layout-sidebar">
      
      <!-- logo -->
      <div id="logo" class="sidebar-header">
        <a href="index.html"><img src="" title="LightYear" alt="悦读管理系统" /></a>
      </div>
      <div class="lyear-layout-sidebar-scroll"> 
        
        <nav class="sidebar-main">
          <ul class="nav nav-drawer">
            <li class="nav-item "> <a href="index.html"><i class="mdi mdi-home"></i> 首页</a> </li>
            
            <li class="nav-item nav-item-has-subnav">
              <a href="javascript:void(0)"><i class=" mdi mdi-account"></i> 用户管理</a>
              <ul class="nav nav-subnav">
                <li> <a href="pages_user.html">所有用户</a> </li>
              </ul>
            </li>
            
            <li class="nav-item nav-item-has-subnav active open">
              <a href="javascript:void(0)"><i class=" mdi mdi-book-open-page-variant"></i> 书籍管理</a>
              <ul class="nav nav-subnav">
                <li> <a href="pages_booklist.html">全部书籍</a> </li>
                <li class="active"> <a href="pages_chapter.html">书籍章节管理</a> </li>
                <li> <a href="pages_add_book.html  ">录入书籍信息</a> </li>
              </ul>
            </li>
            
            <li class="nav-item nav-item-has-subnav">
              <a href="javascript:void(0)"><i class=" mdi mdi-book-multiple-variant"></i> 榜单管理</a>
              <ul class="nav nav-subnav">
                <li> <a href="pages_heat.html">最热书籍</a> </li>
                <li> <a href="pages_latest.html">最新书籍</a> </li>
              </ul>
            </li>
          
            
            <li class="nav-item nav-item-has-subnav">
              <a href="javascript:void(0)"><i class=" mdi mdi-comment"></i> 评论管理</a>
              <ul class="nav nav-subnav">
                <li> <a href="pages_comment.html">所有评论</a> </li>
              </ul>
            </li>
            
          </ul>
        </nav>
        
        
        <div class="sidebar-footer">
          
        </div>
      </div>
      
    </aside>
    <!--End 左侧导航-->
    
    <!--头部信息-->
    <header class="lyear-layout-header">
      
      <nav class="navbar navbar-default">
        <div class="topbar">
          
          <div class="topbar-left">
            <div class="lyear-aside-toggler">
              <span class="lyear-toggler-bar"></span>
              <span class="lyear-toggler-bar"></span>
              <span class="lyear-toggler-bar"></span>
            </div>
            <span class="navbar-page-title"> 章节列表 </span>
          </div>
          
          <ul class="topbar-right">
            <li class="dropdown dropdown-profile">
              <a href="javascript:void(0)" data-toggle="dropdown">
                <img id="adminAvatar" class="img-avatar img-avatar-48 m-r-10" src="" alt="头像" />
                <span id="adminName">管理员 <span class="caret"></span></span>
              </a>
              <ul class="dropdown-menu dropdown-menu-right">
                <li class="active"> <a href="pages_info.html"><i class="mdi mdi-account"></i> 个人信息</a> </li>
                <li> <a href="modify_psd.html"><i class="mdi mdi-lock-outline"></i> 修改密码</a> </li>
                <li class="divider"></li>
                <li> <a href="pages_login.html"><i class="mdi mdi-logout-variant"></i> 退出登录</a> </li>
              </ul>
            </li>
            <!--切换主题配色-->
		    <li class="dropdown dropdown-skin">
			  <span data-toggle="dropdown" class="icon-palette"><i class="mdi mdi-palette"></i></span>
			  <ul class="dropdown-menu dropdown-menu-right" data-stopPropagation="true">
                <li class="drop-title"><p>主题</p></li>
                <li class="drop-skin-li clearfix">
                  <span class="inverse">
                    <input type="radio" name="site_theme" value="default" id="site_theme_1" checked>
                    <label for="site_theme_1"></label>
                  </span>
                  <span>
                    <input type="radio" name="site_theme" value="dark" id="site_theme_2">
                    <label for="site_theme_2"></label>
                  </span>
                  <span>
                    <input type="radio" name="site_theme" value="translucent" id="site_theme_3">
                    <label for="site_theme_3"></label>
                  </span>
                </li>
			    <li class="drop-title"><p>LOGO</p></li>
				<li class="drop-skin-li clearfix">
                  <span class="inverse">
                    <input type="radio" name="logo_bg" value="default" id="logo_bg_1" checked>
                    <label for="logo_bg_1"></label>
                  </span>
                  <span>
                    <input type="radio" name="logo_bg" value="color_2" id="logo_bg_2">
                    <label for="logo_bg_2"></label>
                  </span>
                  <span>
                    <input type="radio" name="logo_bg" value="color_3" id="logo_bg_3">
                    <label for="logo_bg_3"></label>
                  </span>
                  <span>
                    <input type="radio" name="logo_bg" value="color_4" id="logo_bg_4">
                    <label for="logo_bg_4"></label>
                  </span>
                  <span>
                    <input type="radio" name="logo_bg" value="color_5" id="logo_bg_5">
                    <label for="logo_bg_5"></label>
                  </span>
                  <span>
                    <input type="radio" name="logo_bg" value="color_6" id="logo_bg_6">
                    <label for="logo_bg_6"></label>
                  </span>
                  <span>
                    <input type="radio" name="logo_bg" value="color_7" id="logo_bg_7">
                    <label for="logo_bg_7"></label>
                  </span>
                  <span>
                    <input type="radio" name="logo_bg" value="color_8" id="logo_bg_8">
                    <label for="logo_bg_8"></label>
                  </span>
				</li>
				<li class="drop-title"><p>头部</p></li>
				<li class="drop-skin-li clearfix">
                  <span class="inverse">
                    <input type="radio" name="header_bg" value="default" id="header_bg_1" checked>
                    <label for="header_bg_1"></label>                      
                  </span>                                                    
                  <span>                                                     
                    <input type="radio" name="header_bg" value="color_2" id="header_bg_2">
                    <label for="header_bg_2"></label>                      
                  </span>                                                    
                  <span>                                                     
                    <input type="radio" name="header_bg" value="color_3" id="header_bg_3">
                    <label for="header_bg_3"></label>
                  </span>
                  <span>
                    <input type="radio" name="header_bg" value="color_4" id="header_bg_4">
                    <label for="header_bg_4"></label>                      
                  </span>                                                    
                  <span>                                                     
                    <input type="radio" name="header_bg" value="color_5" id="header_bg_5">
                    <label for="header_bg_5"></label>                      
                  </span>                                                    
                  <span>                                                     
                    <input type="radio" name="header_bg" value="color_6" id="header_bg_6">
                    <label for="header_bg_6"></label>                      
                  </span>                                                    
                  <span>                                                     
                    <input type="radio" name="header_bg" value="color_7" id="header_bg_7">
                    <label for="header_bg_7"></label>
                  </span>
                  <span>
                    <input type="radio" name="header_bg" value="color_8" id="header_bg_8">
                    <label for="header_bg_8"></label>
                  </span>
				</li>
				<li class="drop-title"><p>侧边栏</p></li>
				<li class="drop-skin-li clearfix">
                  <span class="inverse">
                    <input type="radio" name="sidebar_bg" value="default" id="sidebar_bg_1" checked>
                    <label for="sidebar_bg_1"></label>
                  </span>
                  <span>
                    <input type="radio" name="sidebar_bg" value="color_2" id="sidebar_bg_2">
                    <label for="sidebar_bg_2"></label>
                  </span>
                  <span>
                    <input type="radio" name="sidebar_bg" value="color_3" id="sidebar_bg_3">
                    <label for="sidebar_bg_3"></label>
                  </span>
                  <span>
                    <input type="radio" name="sidebar_bg" value="color_4" id="sidebar_bg_4">
                    <label for="sidebar_bg_4"></label>
                  </span>
                  <span>
                    <input type="radio" name="sidebar_bg" value="color_5" id="sidebar_bg_5">
                    <label for="sidebar_bg_5"></label>
                  </span>
                  <span>
                    <input type="radio" name="sidebar_bg" value="color_6" id="sidebar_bg_6">
                    <label for="sidebar_bg_6"></label>
                  </span>
                  <span>
                    <input type="radio" name="sidebar_bg" value="color_7" id="sidebar_bg_7">
                    <label for="sidebar_bg_7"></label>
                  </span>
                  <span>
                    <input type="radio" name="sidebar_bg" value="color_8" id="sidebar_bg_8">
                    <label for="sidebar_bg_8"></label>
                  </span>
				</li>
			  </ul>
			</li>
            <!--切换主题配色-->
          </ul>
          
        </div>
      </nav>
      
    </header>
    <!--End 头部信息-->
    <!--页面主要内容-->
    <main class="lyear-layout-content">
      
      <div class="container-fluid">
        
        <div class="row">
          <div class="col-lg-12">
            <div class="card">
              <div class="card-toolbar clearfix">
                <div class="toolbar-btn-action">
                  <a class="btn btn-primary m-r-5" href="#addChapter_Modal" data-toggle="modal"><i class="mdi mdi-plus"></i> 添加章节</a>
                  <a id="delete_chapter_list" class="btn btn-cyan" href="#!"><i class="mdi mdi mdi-delete"></i> 删除章节</a>
                </div>
              </div>
              <div class="card-body">
                
                <div class="table-responsive">
                  <table class="table table-bordered">
                    <thead>
                      <tr>
                        <th>
                          <label class="lyear-checkbox checkbox-primary">
                            <input type="checkbox" id="check-all"><span></span>
                          </label>
                        </th>
                        <th>章节编号</th>
                        <th>书籍编号</th>
                        <th>书籍</th>
                        <th>章节名称</th>
                        <th>章节地址</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody id="chapterlist">
                      
                    </tbody>
                  </table>
                </div>
               <nav>
                  <ul id="pages" class="pagination pagination-circle">
                  
                  </ul>
                </nav>
       
              </div>
            </div>
          </div>
          
        </div>
        
      </div>
      
    </main>
    <!--End 页面主要内容-->
    <!-- 模态框 -->
		<div class="modal fade" id="Modal" tabindex="-1" role="dialog"
			aria-labelledby="exampleModalLabel" style="display: none;">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">×</span>
						</button>
						<h4 class="modal-title" id="exampleModalLabel">修改章节信息</h4>
					</div>
					<div class="modal-body">
						<form id="form_modal">
							<div class="form-group">
								<label for="bookId" class="control-label">书籍id：</label>
								<input type="text" class="form-control" id="bookId" disabled="disabled">
							</div>
							<div class="form-group">
								<label for="bookname" class="control-label">书籍：</label>
								<input type="text" class="form-control" id="bookname">
							</div>
							<div class="form-group">
								<label for="chapterName" class="control-label">章节名：</label>
								<input type="text" class="form-control" id="chapterName">
							</div>
							<div class="form-group">
								<label for="chapterUrl" class="control-label">章节地址：</label>
								<input type="text" class="form-control" id="chapterUrl">
							</div>
							
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default"
							data-dismiss="modal">取消</button>
						<button id="chapter_submit" type="button" class="btn btn-primary">提交</button>
					</div>
				</div>
			</div>
		</div>
		<!-- 新增章节 -->
		<div class="modal fade" id="addChapter_Modal" tabindex="-1" role="dialog"
			aria-labelledby="exampleModalLabel" style="display: none;">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">×</span>
						</button>
						<h4 class="modal-title" id="exampleModalLabel">新增章节</h4>
					</div>
					<div class="modal-body">
						<form id="form_modal">
							<div class="form-group">
								<label for="addChapter_bookId" class="control-label">书籍id：</label>
								<input type="text" class="form-control" id="addChapter_bookId" >
							</div>
							<div class="form-group">
								<label for="addChapter_bookname" class="control-label">书籍：</label>
								<input type="text" class="form-control" id="addChapter_bookname">
							</div>
							<div class="form-group">
								<label for="addChapter_chapterName" class="control-label">章节名：</label>
								<input  type="text" class="form-control" id="addChapter_chapterName">
								<input id="uploadChapter" type="file" style="display: none;">
							</div>
							<div class="form-group">
								<label for="addChapter_chapterUrl" class="control-label">章节地址：</label>
								<input type="text" class="form-control" id="addChapter_chapterUrl">
							</div>
							
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default"
							data-dismiss="modal">取消</button>
						<button id="addChapter_submit" type="button" class="btn btn-primary">提交</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript" src="dialog/dialog_js/MiniDialog-es5.min.js"></script>
<script type="text/javascript">
$(function(){
    $('.search-bar .dropdown-menu a').click(function() {
        var field = $(this).data('field') || '';
        $('#search-field').val(field);
        $('#search-btn').html($(this).text() + ' <span class="caret"></span>');
    });
    
    $("#addChapter_bookId").blur(function(){
    	var bookId = $("#addChapter_bookId").val();
    	console.log(bookId);
    	if(bookId.length>0){
    		$.ajax({
    			url : "http://localhost:8080/2020_wxapp/getBookInfo",
    			type : "POST",
    			dataType : "json",
    			data : {"bookId":bookId},
    			async : false,
    			success : function(data) {
    				if(!data.success){
    					Dialog
    					({
    						title: "添加章节",
    						content: data.msg,
    						draggable: true
    					});
    					$("#addChapter_bookId").val("");
    				}	
    			}
    		})
    		
    	}
    })
    
    var key = "";
    var file_path="";
    var config = {
   		// 上传域名区域，z0指华东地区
   		region: qiniu.region.z0
   	};
   	var putExtra = {
   		// 限制上传文件类型
   		mimeType: null
   	};
    
    $("#addChapter_chapterName").click(function(){
    	document.getElementById("uploadChapter").click();
    })
    
    $("#addChapter_submit").click(function(){
   		var data = {};
   		
    	data.chapterUrl =  $("#addChapter_chapterUrl").val();
    	data.bookId = $("#addChapter_bookId").val();
    	data.bookName = $("#addChapter_bookname").val();
    	data.chapterName = $("#addChapter_chapterName").val();
    	if(data.chapterUrl.length>0 && data.bookId.length && data.bookName.length && data.chapterName.length>0){
    		data = JSON.stringify(data);
        	console.log(data);
        	$.ajax({
    			url : "http://localhost:8080/2020_wxapp/addChapter",
    			type : "POST",
    			dataType : "json",
    			data : {"chapter":data},
    			async : false,
    			success : function(data) {
    				if(!data.success){
    					Dialog
    					({
    						title: "添加章节",
    						content: data.msg,
    						draggable: true
    					});
    					$("#addChapter_bookId").val("");
    				}else{
    					uplaod_qiniu();
    					currentPoint = (total-1)*len;
    					Data = {
							"len" : len,
							"inital" : currentPoint
						};
						page_chapter_load("http://localhost:8080/2020_wxapp/getChapterList", Data);
    				}	
    			}
    		})
    	}
    	else{
    		Dialog.warn( "章节上传：", "章节信息不完整" );
    	}
    })
    
    $("#uploadChapter").change(function(event){
		var files = event.target.files,file;
		if (files && files.length > 0) {
			file_path = files[0];
		    $("#addChapter_chapterName").val(file_path.name.split(".")[0]);
		}else{
			Dialog.info( "文件上传 ", "选择上传文件" );
		}
	});
    
  //上传到七牛云
	function uplaod_qiniu(){
	  key = $("#addChapter_chapterUrl").val();
	  console.log(key);
		//key有效
		if(key.length>0){
			var url = "http://localhost:8080/2020_wxapp/getQiNiuToken";
			$.ajax({
		        url:url,
		        type:"POST",
		        dataType:"json",
		        data:{"key":key},
		        async: false,
		        success:function(data){
		        	if(data.success){
		        		//获取token成功后
		        		var token = data.data;
		        		console.log(token);
		        		if(token.length>0){
		        			var observable = qiniu.upload(file_path, key, token, putExtra, config);
		        			var subscription = observable.subscribe(observable);
		        			Dialog.success( "章节上传", "章节上传成功" );
		        		}else{
		        			Dialog.warn( "文件上传", "文件上传失败" );
		        		}
		        	}
		        },
			});
		}else{
			Dialog.warn( "文件上传：", "文件上传失败" );
		}
	}
    
});
</script>
</body>
</html>